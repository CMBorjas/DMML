<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dungeon Master Assistant</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <h1>Welcome to the Dungeon Master Assistant</h1>

    <h2>Generate NPCs</h2>
    <button id="generateNpcButton">Generate NPC</button>

    <h2>Saved NPCs</h2>
    <div id="npcList">
        <!-- NPCs will be rendered here -->
    </div>

    <script>
        async function fetchNpcs() {
            const response = await fetch('/npc');
            const npcs = await response.json();
            const npcList = document.getElementById('npcList');
            npcList.innerHTML = '';
            npcs.forEach(npc => {
                const npcDiv = document.createElement('div');
                npcDiv.className = 'npc-card';
                npcDiv.innerHTML = `
                    <h3>${npc.name} (${npc.role})</h3>
                    <p><strong>Alignment:</strong> ${npc.alignment}</p>
                    <p><strong>Stats:</strong> ${JSON.stringify(npc.stats)}</p>
                    <p><strong>Description:</strong> ${npc.description}</p>
                    <button onclick="deleteNpc(${npc.id})" class="delete-button">Delete</button>
                    <div class="chat-section">
                        <h4>Chat with ${npc.name}</h4>
                        <div id="chatHistory-${npc.id}" class="chat-history"></div>
                        <div class="chat-input">
                            <input type="text" id="chatInput-${npc.id}" placeholder="Enter your message..." />
                            <button onclick="chatWithNpc(${npc.id})" class="send-button">Send</button>
                        </div>
                    </div>
                `;
                npcList.appendChild(npcDiv);

                // Load existing chat history
                updateChatHistory(npc.id, npc.chat_history);
            });
        }

        async function generateNpc() {
            const response = await fetch('/npc/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (response.ok) {
                fetchNpcs();
            }
        }

        async function deleteNpc(npcId) {
            const response = await fetch(`/npc/${npcId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (response.ok) {
                fetchNpcs();
            } else {
                alert('Failed to delete NPC');
            }
        }

        async function chatWithNpc(npcId) {
            const inputField = document.getElementById(`chatInput-${npcId}`);
            const playerMessage = inputField.value.trim();
            if (!playerMessage) {
                alert('Please enter a message.');
                return;
            }

            const response = await fetch(`/npc/${npcId}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ input: playerMessage })
            });

            if (response.ok) {
                const data = await response.json();
                updateChatHistory(npcId, data.chat_history);
                inputField.value = ''; // Clear the input field
            } else {
                alert('Failed to send message.');
            }
        }

        function updateChatHistory(npcId, chatHistory) {
            const chatHistoryDiv = document.getElementById(`chatHistory-${npcId}`);
            chatHistoryDiv.textContent = chatHistory; // Use `pre-wrap` style for formatting
        }

        document.getElementById('generateNpcButton').addEventListener('click', generateNpc);

        // Fetch and render NPCs on page load
        fetchNpcs();
    </script>
</body>
</html>
